<!DOCTYPE html>
<html>

<body>
    <div id="container">

        <div id="player"></div>
    </div>
    <!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <script>

        //socket conn
        let roomId = location.href.split('/')[3];
        let socket = io.connect('/');
        socket.on('connect', () => {
            socket.emit('join', { roomId });
        });

        // 2. This code loads the IFrame Player API code asynchronously.
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        // 3. This function creates an <iframe> (and YouTube player)
        //    after the API code downloads.
        var player;
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '390',
                width: '640',
                videoId: 'M7lc1UVf-VE',
                events: {
                    //'onStateChange': onPlayerStateChange,
                    'onReady': onPlayerReady
                }
            });
        }

        const onPlayerReady = (event) => {
            console.log('ready');
            event.target.playVideo();
        };
        //TODO: send request to server
        function onPlayerStateChange(event) {
            console.log('emitting');
            let state = player.getPlayerState();
            if (state === YT.PlayerState.PLAYING) {
                let time = player.getCurrentTime();
                socket.emit('play', { time });
            }
            else if (state === YT.PlayerState.PAUSED) {
                socket.emit('pause');
            }
        }
        socket.on('pause', () => {
            player.pauseVideo();
        });
        socket.on('play', (data) => {
            player.seekTo(data.time);
            player.playVideo();
        });



        let myConfObj = {
            iframeMouseOver: false
        }
        let container = document.getElementById('container');
        //get click inside iframe
        window.addEventListener('blur', function () {
            if (myConfObj.iframeMouseOver) {
                //click inside iframe
                onPlayerStateChange();
            }
            setTimeout(() => {
                window.focus();
            }, 0);
        });

        container.addEventListener('mouseover', function () {
            myConfObj.iframeMouseOver = true;
            window.focus();
        });
        container.addEventListener('mouseout', function () {
            myConfObj.iframeMouseOver = false;
        });

    </script>

</body>

</html>